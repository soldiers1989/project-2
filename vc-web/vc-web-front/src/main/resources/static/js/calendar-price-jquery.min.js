/*!
 * Created by Capricorncd on 2017/6/11.
 * https://github.com/capricorncd/calendar-price-jquery
 */
"use strict";(function($){var formatNumber=function(n){n=n.toString();return n[1]?n:"0"+n};var toNumber=function(n){n=parseInt(n);return isNaN(n)?0:n};var isValid=function(date){if(/^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})/.test(date)){return RegExp.$1+"/"+formatNumber(RegExp.$2)+"/"+formatNumber(RegExp.$3)}return false};var formatDate=function(date,fmt){if(/(y+)/i.test(fmt)){fmt=fmt.replace(RegExp.$1,(date.getFullYear()+"").substr(4-RegExp.$1.length))}var obj={"M+":date.getMonth()+1,"d+":date.getDate(),"h+":date.getHours(),"m+":date.getMinutes(),"s+":date.getSeconds()};for(var key in obj){if(new RegExp("("+key+")").test(fmt)){var str=obj[key]+"";fmt=fmt.replace(RegExp.$1,(RegExp.$1.length===1)?str:formatNumber(str))}}return fmt};var createSettingWindow=function(){var div=document.createElement("div");div.className="capricorncd-date-detailed-settings";div.style.display="none";return $(div)};var CODES={1:"请配置日历显示的容器!",2:"{{text}}: 日期格式不合法!",3:"设置的日期范围或初始化的日期范围，与设置的周{{text}}没有交集",4:"开始日期格式错误",5:"开始日期不能小于今天",6:"结束日期格式错误",7:"结束日期不能小于开始日期",8:"sort(arg)方法的参数arg为非数组"};var TODAY=new Date();var today=formatDate(TODAY,"yyyy-MM-dd");var ONE_DAY_MSEC=86400000;var tomorrow=formatDate(new Date(Date.parse(TODAY)+ONE_DAY_MSEC),"yyyy-MM-dd");var DEFAULTS={data:[],month:formatDate(TODAY,"yyyy/MM"),startDate:formatDate(TODAY,"yyyy/MM/dd"),endDate:null,cancel:function(){},callback:function(){},reset:function(){console.log("reset completed!")},error:function(){},hideFooterButton:false,style:{bgColor:"#fff"}};function CalendarPrice(opts){if(!opts.el){opts.error&&opts.error({code:1,msg:CODES[1]})}this.calendar=$(opts.el);this.settingWindow=createSettingWindow();this.opts=$.extend({},DEFAULTS,opts);this.init()}var fn=CalendarPrice.prototype;fn._formatThisMonth=function(month){var thisMonthObj=null;if(/^(\d{4})[-\.\/](\d{1,2})/.test(month)){thisMonthObj=this.dateToObject(RegExp.$1+"/"+RegExp.$2)}else{thisMonthObj=this.dateToObject(formatDate(TODAY,"yyyy/MM"))}if(thisMonthObj<=this.endDate&&thisMonthObj>=this.startDate){return thisMonthObj}else{return this.dateToObject(formatDate(this.startDate,"yyyy/MM"))}};fn.init=function(){this.createStyleCode();this.startDate=this._getStartDate();this.endDate=this._getEndDate();this.data=this._getOptionsData();this.month=this._formatThisMonth(this.opts.month);this.initSettingWindow();this.createCalendar();this.handleClickEvent()};fn._prevMonth=function(){var y=toNumber(formatDate(this.month,"yyyy"));var m=toNumber(formatDate(this.month,"MM"));if(m===1){this.month=this.dateToObject((y-1)+"/12")}else{this.month=this.dateToObject(y+"/"+(m-1))}this.createCalendar()};fn._nextMonth=function(){var y=toNumber(formatDate(this.month,"yyyy"));var m=toNumber(formatDate(this.month,"MM"));if(m===12){this.month=this.dateToObject((y+1)+"/01")}else{this.month=this.dateToObject(y+"/"+(m+1))}this.createCalendar()};fn._getStartDate=function(){var startDate=this.dateToObject(this.opts.startDate);if(startDate&&startDate>=TODAY){return startDate}else{return startDate}};fn._getEndDate=function(){var endDate=this.opts.endDate;var y=null,m=null,d=null;if(/^(\d{4})[-\.\/](\d{1,2})/.test(endDate)){y=RegExp.$1;m=toNumber(RegExp.$2)}if(!y||!m){y=toNumber(formatDate(TODAY,"yyyy"))+1;m=toNumber(formatDate(TODAY,"MM"))}if(/^\d{4}[-\.\/]\d{1,2}[-\.\/](\d{1,2})/.test(endDate)){d=RegExp.$1}else{d=new Date(Date.parse(new Date(y,m))-ONE_DAY_MSEC).getDate()}return this.dateToObject(y+"/"+m+"/"+d)};fn.dateToObject=function(date){var newDate="";var reg=/(\d{4})[-\/\.](\d{1,2})[-\/\.]?/;if(reg.test(date)){newDate+=RegExp.$1+"/"+RegExp.$2}if(/[-\/\.]\d{1,2}[-\/\.](\d{1,2})/.test(date)){newDate+="/"+RegExp.$1}else{newDate+="/"+"01"}if(/\d{4}\/\d{1,2}\/\d{1,2}/.test(newDate)){return new Date(newDate)}else{this.opts.error({code:2,msg:CODES[2].replace("{{text}}",date)});return false}};fn.createCalendar=function(){var showPrevBtn=true;var showNextBtn=true;var thisMonthYM=formatDate(this.month,"yyyyMM");var setStartMonth=formatDate(this.startDate,"yyyyMM");if(setStartMonth>=thisMonthYM){showPrevBtn=false}var setEndMonth=formatDate(this.endDate,"yyyyMM");if(setEndMonth<=thisMonthYM){showNextBtn=false}var html="";html+='<div class="capricorncd-calendar-container">';html+='	<div class="calendar-head-wrapper">';if(showPrevBtn){html+='       <a class="prev-month" title="上一月"></a>'}html+='		<div class="calendar-month-title">'+formatDate(this.month,"yyyy年MM月")+"</div>";if(showNextBtn){html+='       <a class="next-month" title="下一月"></a>'}html+="	</div>";html+='	<div class="calendar-table-wrapper">';html+='  	    <table cellpadding="4" cellspacing="0">';html+='		    <thead><tr class="week"><th class="weekend">日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th class="weekend">六</th></tr></thead>';html+="		    <tbody>"+this._createTbody()+"</tbody>";html+="	    </table>";html+="    </div>";if(!this.opts.hideFooterButton){html+='    <div class="calendar-foot-wrapper">';
    html+='        <button class="btn btn-reset">重置</button>';html+='        <button class="btn btn-confirm">确定</button>';html+='        <button class="btn btn-cancel">取消</button>';html+="    </div>"}html+="</div>";this.calendar.html(html);this.renderDataToTalbe()};fn._createTbody=function(){var thisMonthDays=this._getMonthDays();var firstDayIsWeek=this.month.getDay();var d=0;var rows=Math.ceil((thisMonthDays+firstDayIsWeek)/7);var tdId="";var html="";var startDay=formatDate(this.startDate,"yyyy-MM-dd");var endDay=formatDate(this.endDate,"yyyy-MM-dd");for(var i=0;i<rows;i++){html+="<tr>";for(var k=1;k<=7;k++){d=i*7+k-firstDayIsWeek;if(d>0&&d<=thisMonthDays){tdId=formatDate(this.month,"yyyy-MM-")+formatNumber(d);if(today==tdId){d="今天"}if(tomorrow==tdId){d="明天"}if(tdId>=startDay&&tdId<=endDay){html+='<td class="valid-hook" data-week="'+(k-1)+'" data-id="'+tdId+'"><b>'+d+'</b><div class="data-hook"></div></td>'}else{html+='<td class="disabled"><b>'+d+"</b></td>"}}else{html+="<td>&nbsp;</td>"}}html+="</tr>"}return html};fn.renderDataToTalbe=function(){var me=this;var dayData=null;var html="";this.calendar.find(".valid-hook").each(function(){dayData=me._getDateData($(this).data("id"));html=me.dayComplate().toString();if(dayData){for(var key in dayData){html=html.replace("{"+key+"}",dayData[key])}$(this).data("data",JSON.stringify(dayData)).find(".data-hook").html(html)}else{$(this).data("data","{}")}})};fn._getDateData=function(day_id){var arr=this.data;for(var i=0;i<arr.length;i++){if(day_id==arr[i].date){return arr[i];break}}return null};fn._getMonthDays=function(){var month=this.month;var y=formatDate(month,"yyyy");var m=formatDate(month,"MM");if(m==12){return 31}else{return(new Date(Date.parse(new Date(y,m,1))-ONE_DAY_MSEC)).getDate()}};fn.initSettingWindow=function(){var html="";html+='<div class="cddsw-container">';html+='   <div class="cddsw-head-wrapper">';html+='       <div class="cddsw-title">0000-00-00</div>';html+='       <a class="cddsw-close"><i></i></a>';html+="   </div>";html+='   <ul class="cddsw-form-wrapper clearfix">';html+=this._createDaySetupInputGroup();html+="   </ul>";html+='   <fieldset class="cddsw-batch-settings clearfix">';html+='       <legend class="bs-title"><b>批量设置</b></legend>';html+='       <div class="bs-content">';html+='           <lable class="bs-lable">日期范围</lable>';html+='           <div class="bs-options-wrapper">';html+='               <input class="itext" name="startDay" type="text">';html+='               <span class="white-space">-</span>';html+='               <input class="itext" name="endDay" type="text">';html+='               <label class="drw-enable"><input name="enableDateRange" type="checkbox"> 启用</label>';html+="           </div>";html+="       </div>";html+='       <div class="bs-content bs-week-chekbox">';html+='           <lable class="bs-lable">设置星期</lable>';html+='           <div class="bs-options-wrapper">';html+='               <label><input name="setWeek" type="checkbox" value="1"> 周一</label>';html+='               <label><input name="setWeek" type="checkbox" value="2"> 周二</label>';html+='               <label><input name="setWeek" type="checkbox" value="3"> 周三</label>';html+='               <label><input name="setWeek" type="checkbox" value="4"> 周四</label>';html+='               <label><input name="setWeek" type="checkbox" value="5"> 周五</label>';html+='               <label><input name="setWeek" type="checkbox" value="6"> 周六</label>';html+='               <label><input name="setWeek" type="checkbox" value="0"> 周日</label>';html+="           </div>";html+="       </div>";html+="   </fieldset>";html+='   <div class="cddsw-foot-wrapper">';html+='       <button class="btn-confirm">启用本设置</button>';html+='       <button class="btn-cancel">取消</button>';html+="   </div>";html+="</div>";this.settingWindow.html(html);$("body").append(this.settingWindow)};fn._createDaySetupInputGroup=function(){var html="";var config=this.opts.config;for(var i=0;i<config.length;i++){var val=config[i];html+="<li>";html+="   <label>"+val.name+"</label>";html+='   <input name="'+val.key+'" type="text">';html+="</li>"}return html};fn.dayComplate=function(){var arr=this.opts.show;var html="";if(arr&&arr instanceof Array){for(var i=0;i<arr.length;i++){var val=arr[i];html+="<p>"+val.name+"{"+val.key+"}</p>"}}return html};fn.handleClickEvent=function(){var me=this;this.calendar.on("click",".prev-month",function(){me._prevMonth()});this.calendar.on("click",".next-month",function(){me._nextMonth()});this.calendar.on("click",".btn-reset",function(){me.data=me._getOptionsData();me.createCalendar();me.opts.reset()});this.calendar.on("click",".btn-confirm",function(){me.opts.callback(me.data)});this.calendar.on("click",".btn-cancel",function(){me.opts.cancel()});this.calendar.on("click",".valid-hook",function(){var thisDate=$(this).data("id");var data=$(this).data("data");try{data=JSON.parse(data)}catch(e){data={}}if(me.opts.everyday){me.opts.everyday(data);return}me.settingWindow.find('.cddsw-form-wrapper [type="text"]').val("");
    me.settingWindow.find('[name="enableDateRange"]').prop("checked",false);me.settingWindow.find('[name="setWeek"]').prop("checked",false);$.each(data,function(key,val){me.settingWindow.find('[name="'+key+'"]').val(val)});me.settingWindow.find(".cddsw-title").html(thisDate);me.settingWindow.find('[name="startDay"], [name="endDay"]').val(thisDate);me.settingWindow.show()});this.settingWindow.on("click",".cddsw-close, .btn-cancel",function(){me.settingWindow.hide()});this.settingWindow.on("click",".btn-confirm",function(){var $dateSetWrapper=$(this).closest(".cddsw-container");var thisDate=$dateSetWrapper.find(".cddsw-title").text();var setData={};$dateSetWrapper.find(".cddsw-form-wrapper [name]").each(function(){var key=$(this).attr("name");var val=$(this).val();setData[key]=val});setData.date=thisDate;var $batch=$(".cddsw-batch-settings");var startDay=$batch.find('[name="startDay"]').val();var endDay=$batch.find('[name="endDay"]').val();var IS_ENABLE=$batch.find('[name="enableDateRange"]').is(":checked");var weeks=[];$batch.find('[name="setWeek"]:checked').each(function(){weeks.push($(this).val())});var setDateRangeArr=[];if(IS_ENABLE){var HSDRD=me.handleSetDateRangeData(startDay,endDay);if(!HSDRD){return}setDateRangeArr=HSDRD;if(weeks.length===0){me.handleThisData(setData,setDateRangeArr);return}}else{if(weeks.length===0){me.handleThisData(setData);return}else{setDateRangeArr=me.handleSetDateRangeData(formatDate(me.startDate,"yyyy-MM-dd"),formatDate(me.endDate,"yyyy-MM-dd"))}}var intersectionDate=me.handleSetWeekData(weeks,setDateRangeArr);if(intersectionDate.length>0){me.handleThisData(setData,intersectionDate)}else{me.opts.error({code:3,msg:CODES[3].replace("{{text}}",weeks.join(","))})}})};fn._createDateRangeArr=function(sd,ed){var dates=[];var sdMsec=Date.parse(this.dateToObject(sd));var edMsec=Date.parse(this.dateToObject(ed));var days=Math.floor((edMsec-sdMsec)/ONE_DAY_MSEC)+1;for(var i=0;i<days;i++){var date=new Date(sdMsec+ONE_DAY_MSEC*i);dates.push(formatDate(date,"yyyy-MM-dd"))}return dates};fn.handleSetDateRangeData=function(startDay,endDay){var arr=[];var sd=isValid(startDay);var ed=isValid(endDay);if(!sd){this.opts.error({code:4,msg:CODES[4]});return null}else{if(sd<today){this.opts.error({code:5,msg:CODES[5]});return null}}if(!ed){this.opts.error({code:6,msg:CODES[6]});return null}else{if(ed<sd){this.opts.error({code:7,msg:CODES[7]});return null}}if(sd==ed){arr.push(formatDate(this.dateToObject(sd),"yyyy-MM-dd"))}else{arr=this._createDateRangeArr(sd,ed)}return arr};fn.handleSetWeekData=function(week,setDateRangeArr){var me=this;var arr=[];$.each(setDateRangeArr,function(key,val){var weekNum=me.dateToObject(val).getDay();if(week.join(",").indexOf(weekNum)>-1){arr.push(val)}});return arr};fn.handleThisData=function(setData,dateArr){var arr=dateArr||[];var len=arr.length;if(len===0){this._updateThisData(setData)}else{for(var i=0;i<len;i++){this._updateThisData(setData,arr[i])}}this.data=this.sort(this.rmRepeat(this.data,"date"));this.renderDataToTalbe();this.settingWindow.hide()};fn._updateThisData=function(setData,dateString){var me=this;var is_existence=false;var data={};if(dateString){data.date=dateString}else{data.date=setData.date}$.each(setData,function(key,val){if(key!="date"){data[key]=val}});$.each(this.data,function(key,val){if(data.date===val.date){is_existence=true;me.data[key]=data;return false}});if(!is_existence){this.data.push(data)}};fn._getOptionsData=function(){var startDay=formatDate(this.startDate,"yyyy-MM-dd");var endDay=formatDate(this.endDate,"yyyy-MM-dd");var arr=[];$.each(this.opts.data,function(key,val){if(val.date>=startDay&&val.date<=endDay){arr.push(val)}});return this.sort(this.rmRepeat(arr,"date"))};fn.createStyleCode=function(){var style=this.opts.style||{};var count=0;for(var key in style){count++;if(count>0){break}}if(!count){return}var defaultStyle={headerBgColor:"#098cc2",headerTextColor:"#fff",weekBgColor:"#098cc2",weekTextColor:"#fff",weekendBgColor:"#098cc2",weekendTextColor:"#fff",validDateTextColor:"#333",validDateBgColor:"#fff",validDateBorderColor:"#eee",validDateHoverBgColor:"#098cc2",validDateHoverTextColor:"#fff",invalidDateTextColor:"#ccc",invalidDateBgColor:"#fff",invalidDateBorderColor:"#eee",footerBgColor:"#fff",resetBtnBgColor:"#77c351",resetBtnTextColor:"#fff",resetBtnHoverBgColor:"#55b526",resetBtnHoverTextColor:"#fff",confirmBtnBgColor:"#098cc2",confirmBtnTextColor:"#fff",confirmBtnHoverBgColor:"#00649a",confirmBtnHoverTextColor:"#fff",cancelBtnBgColor:"#fff",cancelBtnBorderColor:"#bbb",cancelBtnTextColor:"#999",cancelBtnHoverBgColor:"#fff",cancelBtnHoverBorderColor:"#bbb",cancelBtnHoverTextColor:"#666"};var concatStyle=$.extend({},defaultStyle,this.opts.style);var templateStyle=".capricorncd-calendar-container .calendar-head-wrapper, .capricorncd-date-detailed-settings .cddsw-container .cddsw-head-wrapper{background-color: {headerBgColor}}"+".capricorncd-calendar-container .calendar-head-wrapper .calendar-month-title, .capricorncd-date-detailed-settings .cddsw-container .cddsw-head-wrapper .cddsw-title{color: {headerTextColor};}"+".capricorncd-calendar-container .calendar-table-wrapper table .week{background-color:{weekBgColor};color:{weekTextColor}};"+".capricorncd-calendar-container .calendar-table-wrapper table .week th.weekend{background-color:{weekendBgColor};color:{weekendTextColor}}"+".capricorncd-calendar-container .calendar-table-wrapper table td{color:{validDateTextColor};background-color:{validDateBgColor};border-bottom: 1px solid {validDateBorderColor};border-right: 1px solid {validDateBorderColor};}"+".capricorncd-calendar-container .calendar-table-wrapper table td.valid-hook:hover{background-color:{validDateHoverBgColor};}"+".capricorncd-calendar-container .calendar-table-wrapper table td.valid-hook:hover b, .capricorncd-calendar-container .calendar-table-wrapper table td.valid-hook:hover p{color: {validDateHoverTextColor}}"+".capricorncd-calendar-container .calendar-table-wrapper table td.disabled{color:{invalidDateTextColor};background-color:{invalidDateBgColor}; border-bottom: 1px solid {invalidDateBorderColor};border-right: 1px solid {invalidDateBorderColor};}"+".capricorncd-calendar-container .calendar-foot-wrapper, .capricorncd-date-detailed-settings .cddsw-foot-wrapper{background-color:{footerBgColor}}"+".capricorncd-calendar-container .calendar-foot-wrapper button.btn-reset{background-color: {resetBtnBgColor};border: 1px solid {resetBtnBgColor};color: {resetBtnTextColor}}.capricorncd-calendar-container .calendar-foot-wrapper button.btn-reset:hover{background-color: {resetBtnHoverBgColor};border: 1px solid {resetBtnHoverBgColor};color: {resetBtnHoverTextColor}}"+".capricorncd-calendar-container .calendar-foot-wrapper button.btn-confirm, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-confirm {background-color: {confirmBtnBgColor};border: 1px solid {confirmBtnBgColor};color: {confirmBtnTextColor}}"+".capricorncd-calendar-container .calendar-foot-wrapper button.btn-confirm:hover, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-confirm:hover {background-color: {confirmBtnHoverBgColor};border: 1px solid {confirmBtnHoverBgColor};color: {confirmBtnHoverTextColor}}"+".capricorncd-calendar-container .calendar-foot-wrapper button.btn-cancel, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-cancel {background-color: {cancelBtnBgColor};color:{cancelBtnTextColor};border: 1px solid {cancelBtnBorderColor};}"+".capricorncd-calendar-container .calendar-foot-wrapper button.btn-cancel:hover, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-cancel:hover {background-color: {cancelBtnHoverBgColor};border-color: {cancelBtnHoverBorderColor};color: {cancelBtnHoverTextColor}}";
    var reg=null;for(var key in concatStyle){reg=eval("/{"+key+"}/g");templateStyle=templateStyle.replace(reg,concatStyle[key])}$("head").append("<style>"+templateStyle+"</style>")};fn.sort=function(arr){if(!(arr instanceof Array)){this.opts.error({code:8,msg:CODES[8]});return arr}if(arr.length<1){return arr}var minIndex=0;var fontObj=null;for(var i=0;i<arr.length;i++){minIndex=i;for(var j=i+1;j<arr.length;j++){if(arr[j].date<arr[minIndex].date){minIndex=j;fontObj=arr[i];arr.splice(i,1,arr[j]);arr.splice(j,1,fontObj)}}}return arr};fn.rmRepeat=function(arr,key){var hash={};var newArr=[];for(var i=0;i<arr.length;i++){var val=arr[i];if(key){try{val=arr[i][key]}catch(e){}}if(hash[val]){continue}newArr.push(arr[i]);hash[val]=true}return newArr};$.extend({CalendarPrice:function(opts){new CalendarPrice(opts)}})})(jQuery);